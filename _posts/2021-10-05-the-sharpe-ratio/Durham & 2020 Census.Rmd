---
title: "Demographic Change in Durham last 10 years"
description: |
  2020 Census results in Durham.
author:
  - name: Jacob Ford
    url: https://example.com/norajones
date: 10-05-2021
output:
  distill::distill_article:
    self_contained: false
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)

trm_taz_g2 <- st_read("C:/Users/JacobFo/OneDrive - City of Durham/Archive/TRM_G2_TAZ_CaliperUpdated.shp")

```
 
Just how much has Durham changed demographically in the last ten years? 



```{r message=FALSE, warning=FALSE, include=FALSE}
##Get Data

library(caliperR)
library(nngeo)
library(tcadr)
library(sf)
library(leaflet)
library(PL94171)
library(janitor)
library(dplyr)
library(tidycensus)
library(tidyverse)
options(tigris_use_cache = TRUE)
library(sf)
library(data.table)
library(dplyr)


#Read PL Data in for 2020 census

part1_file_path <- "C:/Users/JacobFo/OneDrive - City of Durham/TRM G2/2020 Census/August Release/PL Data/nc000012020.pl"
part1  <- read.delim(part1_file_path, header=FALSE, colClasses="character", sep="|")

part2_file_path <- "C:/Users/JacobFo/OneDrive - City of Durham/TRM G2/2020 Census/August Release/PL Data/nc000022020.pl"
part2  <- read.delim(part2_file_path, header=FALSE, colClasses="character", sep="|")

part3_file_path <- "C:/Users/JacobFo/OneDrive - City of Durham/TRM G2/2020 Census/August Release/PL Data/nc000032020.pl"
part3  <- read.delim(part3_file_path, header=FALSE, colClasses="character", sep="|")

geo_file_path <- "C:/Users/JacobFo/OneDrive - City of Durham/TRM G2/2020 Census/August Release/PL Data/ncgeo2020.pl"
geo  <- read.delim(geo_file_path, header=FALSE, colClasses="character", sep="|")

#Rename Columns

colnames(geo) <- c("FILEID", "STUSAB", "SUMLEV", "GEOVAR", "GEOCOMP", "CHARITER", "CIFSN", "LOGRECNO", "GEOID", 
  "GEOCODE", "REGION", "DIVISION", "STATE", "STATENS", "COUNTY", "COUNTYCC", "COUNTYNS", "COUSUB",
  "COUSUBCC", "COUSUBNS", "SUBMCD", "SUBMCDCC", "SUBMCDNS", "ESTATE", "ESTATECC", "ESTATENS", 
  "CONCIT", "CONCITCC", "CONCITNS", "PLACE", "PLACECC", "PLACENS", "TRACT", "BLKGRP", "BLOCK", 
  "AIANHH", "AIHHTLI", "AIANHHFP", "AIANHHCC", "AIANHHNS", "AITS", "AITSFP", "AITSCC", "AITSNS",
  "TTRACT", "TBLKGRP", "ANRC", "ANRCCC", "ANRCNS", "CBSA", "MEMI", "CSA", "METDIV", "NECTA",
  "NMEMI", "CNECTA", "NECTADIV", "CBSAPCI", "NECTAPCI", "UA", "UATYPE", "UR", "CD116", "CD118",
  "CD119", "CD120", "CD121", "SLDU18", "SLDU22", "SLDU24", "SLDU26", "SLDU28", "SLDL18", "SLDL22",
  "SLDL24", "SLDL26", "SLDL28", "VTD", "VTDI", "ZCTA", "SDELM", "SDSEC", "SDUNI", "PUMA", "AREALAND",
  "AREAWATR", "BASENAME", "NAME", "FUNCSTAT", "GCUNI", "POP100", "HU100", "INTPTLAT", "INTPTLON", 
  "LSADC", "PARTFLAG", "UGA")
colnames(part1) <- c("FILEID", "STUSAB", "CHARITER", "CIFSN", "LOGRECNO", 
                     paste0("P00", c(10001:10071, 20001:20073)))
colnames(part2) <- c("FILEID", "STUSAB", "CHARITER", "CIFSN", "LOGRECNO", 
                     paste0("P00", c(30001:30071, 40001:40073)), 
                     paste0("H00", 10001:10003))
colnames(part3) <- c("FILEID", "STUSAB", "CHARITER", "CIFSN", "LOGRECNO",
                     paste0("P00", 50001:50010))

#combine

combine <- Reduce(function(x,y) {merge(x, y, by=c("LOGRECNO", "STUSAB", "FILEID", "CHARITER"))}, list(geo[,-7], part1[,-4], part2[,-4], part3))

combine <- combine[order(combine$LOGRECNO), c("FILEID", "STUSAB", "SUMLEV", "GEOVAR", "GEOCOMP", "CHARITER", "CIFSN", "LOGRECNO", "GEOID", 
                                              "GEOCODE", "REGION", "DIVISION", "STATE", "STATENS", "COUNTY", "COUNTYCC", "COUNTYNS", "COUSUB",
                                              "COUSUBCC", "COUSUBNS", "SUBMCD", "SUBMCDCC", "SUBMCDNS", "ESTATE", "ESTATECC", "ESTATENS", 
                                              "CONCIT", "CONCITCC", "CONCITNS", "PLACE", "PLACECC", "PLACENS", "TRACT", "BLKGRP", "BLOCK", 
                                              "AIANHH", "AIHHTLI", "AIANHHFP", "AIANHHCC", "AIANHHNS", "AITS", "AITSFP", "AITSCC", "AITSNS",
                                              "TTRACT", "TBLKGRP", "ANRC", "ANRCCC", "ANRCNS", "CBSA", "MEMI", "CSA", "METDIV", "NECTA",
                                              "NMEMI", "CNECTA", "NECTADIV", "CBSAPCI", "NECTAPCI", "UA", "UATYPE", "UR", "CD116", "CD118",
                                              "CD119", "CD120", "CD121", "SLDU18", "SLDU22", "SLDU24", "SLDU26", "SLDU28", "SLDL18", "SLDL22",
                                              "SLDL24", "SLDL26", "SLDL28", "VTD", "VTDI", "ZCTA", "SDELM", "SDSEC", "SDUNI", "PUMA", "AREALAND",
                                              "AREAWATR", "BASENAME", "NAME", "FUNCSTAT", "GCUNI", "POP100", "HU100", "INTPTLAT", "INTPTLON", 
                                              "LSADC", "PARTFLAG", "UGA", paste0("P00", c(10001:10071, 20001:20073)), paste0("P00", c(30001:30071, 40001:40073)), 
                                              paste0("H00", 10001:10003), paste0("P00", 50001:50010))]
rownames(combine) <- 1:nrow(combine)

county_fips <- c("001","037","063","069","077","085","101","127","135","145","183")

##Sum Level 750 is blocks

prep_census_2020 <- combine %>%
  filter(combine$COUNTY %in% county_fips & combine$SUMLEV == "750")

clean_census <- pl_select_standard(prep_census_2020, clean_names=TRUE)

##Household Bucket: HH = H0010002,occupied households; H0010001 is Total

clean_census$HH <- as.integer(prep_census_2020$H0010002  )

##Population Buckets: HH, HH_Pop, NonHH_Pop


clean_census$pop <- as.integer(clean_census$pop)


clean_census$InstPop <- as.integer(prep_census_2020$P0050002)
clean_census$Correctional <- as.integer(prep_census_2020$P0050003)
clean_census$Juvenile <- as.integer(prep_census_2020$P0050004)
clean_census$NursingHome <- as.integer(prep_census_2020$P0050005)
clean_census$OtherInst <- as.integer(prep_census_2020$P0050006)
clean_census$NonInstPop <- as.integer(prep_census_2020$P0050007)

#Other_NonInst_GQ is the total of Stud_GQ, Military and OtherNon, differs slightly from our own
clean_census$Stud_GQ <- as.integer(prep_census_2020$P0050008)
clean_census$Military <- as.integer(prep_census_2020$P0050009)
clean_census$OtherNon <- as.integer(prep_census_2020$P0050010)

clean_census$TotalPop <- clean_census$pop
clean_census$HH_Pop <- clean_census$TotalPop - clean_census$NonInstPop - clean_census$InstPop

clean_census$NonHH_Pop <- clean_census$NonInstPop + clean_census$InstPop

clean_census$WhiteAlone <- prep_census_2020$P0010003
clean_census$Black <- prep_census_2020$P0010004
clean_census$Asian <- prep_census_2020$P0010006
clean_census$Hispanic <- prep_census_2020$P0040002


#Join with empty 2020 block layer got from get_decennial. Clean GEOID
clean_census$GEOID_v2 <- sub(".*7500000US", "", clean_census$GEOID)

blocks_2020 <- read_sf('C:/Users/JacobFo/OneDrive - City of Durham/2020 Blocks Backup/2020_Census_Blocks.shp') 

blocks_2020 <- blocks_2020 %>%
  select(GEOID20, county, geometry)

blocks_2020$GEOID_v2 <- blocks_2020$GEOID20

##Tag each to get the geometry
census_2020 <- clean_census %>%
  select(GEOID_v2, TotalPop, HH_Pop, NonHH_Pop, Stud_GQ, HH, WhiteAlone, Black, Asian, Hispanic )

census_2020$WhiteAlone <- as.integer(census_2020$WhiteAlone)
census_2020$Black <- as.integer(census_2020$Black)
census_2020$Asian <- as.integer(census_2020$Asian)
census_2020$Hispanic <- as.integer(census_2020$Hispanic)

##Final Join

prep_2020 <- st_as_sf(left_join(census_2020,blocks_2020, by="GEOID_v2"))

durham_2020_blocks <- prep_2020 %>%
  filter(county=="063") %>%
  mutate(pctWhite_20 = WhiteAlone/(WhiteAlone+ Black+ Asian+Hispanic),
         pctBlack_20 =Black/(WhiteAlone+ Black+ Asian+Hispanic), 
         pctAsian_20 =Asian/(WhiteAlone+ Black+ Asian+Hispanic),
         pctHispanic_20 =Hispanic/(WhiteAlone+ Black+ Asian+Hispanic))




```

```{r}

my_counties <- unique(trm_taz_g2$COUNTY)

```




```{r message=FALSE, warning=FALSE}
nc_2010 <- get_decennial(geography = "block", state="NC", county = my_counties,
                       variables = c(HH="H003002",
                                     Hispanic="P004003",
                                     Black="P012B001",
                                     White="P012A001",
                                     Asian="H006005",
                                     TotalPop="H006001"), 
                       year = 2010, geometry=TRUE)


temp <- nc_2010 %>%
  group_by(GEOID) %>%
  summarize(HH=sum(value[variable=="HH"], na.rm=T),
            TotalPop=sum(value[variable=="TotalPop"], na.rm=T),
             Black=sum(value[variable=="Black"], na.rm=T),
             White=sum(value[variable=="White"], na.rm=T),
             Asian=sum(value[variable=="Asian"], na.rm=T),
             Hispanic=sum(value[variable=="Hispanic"], na.rm=T))


nc_2010_final <- temp %>%
    mutate(pctWhite_10 = White/(White+ Black+ Asian+Hispanic),
         pctBlack_10 =Black/(White+ Black+ Asian+Hispanic), 
         pctAsian_10 =Asian/(White+ Black+ Asian+Hispanic),
         pctHispanic_10 =Hispanic/(White+ Black+ Asian+Hispanic))

```

```{r message=FALSE, warning=FALSE, include=FALSE}
vars <- load_variables(2010, "sf1", cache = TRUE)

View(vars)
```





```{r echo=FALSE, message=FALSE, warning=FALSE}
library(scales)



pal <- colorNumeric(
  palette = "YlOrRd", na.color = "#808080",
  domain = durham_2010_blocks_final$pctWhite_10)

pal_a <- colorNumeric(
  palette = "YlOrRd", na.color = "#808080",
  domain = durham_2020_blocks$pctWhite_20)

pal_2 <- colorNumeric(
  palette = "YlGnBu", na.color = "#808080",
  domain = durham_2010_blocks_final$pctBlack_10)

pal_2_a <- colorNumeric(
  palette = "YlGnBu", na.color = "#808080",
  domain = durham_2020_blocks$pctBlack_20)

pal_3 <- colorNumeric(
  palette = "YlOrBr", na.color = "#808080",
  domain = durham_2010_blocks_final$pctHispanic_10)

pal_3_a <- colorNumeric(
  palette = "YlOrBr", na.color = "#808080",
  domain = durham_2020_blocks$pctHispanic_20)

durham_2010_blocks_final <- st_as_sf(durham_2010_blocks_final)

map <- leaflet(durham_2010_blocks_final) %>%
  addProviderTiles("CartoDB.Positron") %>%
  ##Whites
  addPolygons(data=durham_2010_blocks_final,
              fillColor=~pal(pctWhite_10),
              stroke=FALSE, weight=2,fillOpacity = 0.7,
              popup = paste("GEOID: ", durham_2010_blocks_final$GEOID , "<br>",
                            "Pct White Alone: ", durham_2010_blocks_final$pctWhite_10
                            ), 
              label="White_2010",
            group="White_2010") %>%
  addLegend("bottomright",
            pal=pal,
            value=durham_2010_blocks_final$pctWhite_10,
            label="White_2010",
            title="Percent White 2010",
            group="White_2010") %>%
  
  addPolygons(data=durham_2020_blocks,
              fillColor=~pal_a(pctWhite_20),
              stroke=FALSE,weight=2,fillOpacity=0.7,
              popup=paste("GEOID: ", durham_2020_blocks$GEOID_v2, "<br>",
                          "Pct White Alone: ", durham_2020_blocks$pctWhite_20),
              label="White_2020",
              group="White_2020") %>%
    addLegend("bottomright",
            pal=pal_a,
            value=durham_2020_blocks$pctWhite_20,
            label="White_2020",
            title="Percent White 2020",
            group="White_2020") %>%
  
  
  
  
  ##Blacks
  addPolygons(data=durham_2010_blocks_final,
              fillColor=~pal_2(pctBlack_10),
              stroke=FALSE, weight=2, fillOpacity=0.6,
              popup = paste("GEOID: ", durham_2010_blocks_final$GEOID, "<br>",
                            "Pct Black Alone: ", durham_2010_blocks_final$pctBlack_10),
              label="Black_2010",
            group="Black_2010") %>%
    addLegend("bottomright",
            pal=pal_2,
            value=durham_2010_blocks_final$pctBlack_10,
            label="Black_2010",
            title="Percent Black 2010",
            group="Black_2010") %>%
  
    addPolygons(data=durham_2020_blocks,
              fillColor=~pal_2_a(pctBlack_20),
              stroke=FALSE,weight=2,fillOpacity=0.7,
              popup=paste("GEOID: ", durham_2020_blocks$GEOID_v2, "<br>",
                          "Pct Black Alone: ", durham_2020_blocks$pctBlack_20),
              label="Black_2020",
              group="Black_2020") %>%
    # addLegend("bottomright",
    #         pal=pal_2_a,
    #         value=durham_2020_blocks$PctBlack_20,
    #         label="Black_2020",
    #         title="Percent Black 2020",
    #         group="Black_2020") %>%


  ##Hispanics
  addPolygons(data=durham_2010_blocks_final,
              fillColor=~pal_3(pctHispanic_10),
              stroke=FALSE, weight=2, fillOpacity=0.6,
              popup = paste("GEOID: ", durham_2010_blocks_final$GEOID, "<br>",
                            "Pct Hispanic Alone: ", durham_2010_blocks_final$pctHispanic_10),
              label="Hispanic_2010",
            group="Hispanic_2010") %>%
    addLegend("bottomright",
            pal=pal_3,
            value=durham_2010_blocks_final$pctHispanic_10,
            label="Hispanic_2010",
            title="Percent Hispanic 2010",
            group="Hispanic_2010") %>%
  
  addPolygons(data=durham_2020_blocks,
              fillColor=~pal_3_a(pctHispanic_20),
              stroke=FALSE,weight=2,fillOpacity=0.7,
              popup=paste("GEOID: ", durham_2020_blocks$GEOID_v2, "<br>",
                          "Pct Hispanic Alone: ", durham_2020_blocks$pctHispanic_20),
              label="Hispanic_2020",
              group="Hispanic_2020") %>%
    addLegend("bottomright",
            pal=pal_3_a,
            value=durham_2020_blocks$pctHispanic_20,
            label="Hispanic_2020",
            title="Percent Hispanic 2020",
            group="Hispanic_2020") %>%
  
  
  
  
  
  
  addLayersControl(overlayGroups = c("White_2010", "White_2020", "Black_2010", "Black_2020", "Hispanic_2010", "Hispanic_2020"))

map %>% hideGroup("White_2010") %>% hideGroup("Hispanic_2010") %>% hideGroup("White_2020")%>% hideGroup("Hispanic_2020")%>% hideGroup("Black_2020")

```






TLD 

```{r}
getwd()
```






2020 census data is available at the block level, allowing us to see the concentration of population by race and age - and how those have changed since 2010. 

The goal of this blog will be to analyze how each congresssional district measures up to each other in demographic representation. Has Asheville's 11th become more or less white since 2010? Where are Hispanics, a growing percentage of 

Steps:

1. Overall compare 2010 to 2020 - how many more people, HH's, white-only, black and hispanics since 2010? 
2. Compare each congressional district's demographic data to each other - not so much diving into packing vs cracking, but just higher level comparison's. 

Let's load the 2019 Congressional District and take a look - what

```{r}
nc_congressional_2019 <- st_read("C:/Users/JacobFo/OneDrive - City of Durham/GitHub/Personal Blog/Personal Blog/Voting Districts/2019 NC Congressional/NC_Congress_2019.shp")

trm_taz_g2 <- st_read("C:/Users/JacobFo/OneDrive - City of Durham/Archive/TRM_G2_TAZ_CaliperUpdated.shp")


temp <- st_transform(nc_congressional_2019, st_crs(trm_taz_g2)) %>% st_make_valid()

pal <- colorFactor(
  palette=c('blue','red'),
  domain=temp$sParty
)



leaflet(temp) %>%
  addProviderTiles("CartoDB.Positron") %>%
  addPolygons(data=temp,
              popup=paste("Congressional District: ", temp$District, "<br>",
                          "Party: ", temp$sParty, "<br>",
                          "Representative 2019: ", temp$sName),
              weight=1,
              color =~pal(temp$sParty))


```




























