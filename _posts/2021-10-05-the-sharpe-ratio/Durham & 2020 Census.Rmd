---
title: "Demographic Change in Durham last 10 years"
description: |
  2020 Census results in Durham.
author:
  - name: Jacob Ford
    url: https://example.com/norajones
date: 10-05-2021
output:
  distill::distill_article:
    self_contained: false
---








```{r setup, include=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
library(caliperR)
library(nngeo)
library(tcadr)
library(sf)
library(leaflet)
library(PL94171)
library(janitor)
library(dplyr)
library(tidycensus)
library(tidyverse)
options(tigris_use_cache = TRUE)
library(sf)
library(data.table)
library(dplyr)

# remotes::install_github("walkerke/tidycensus")
# remotes::install_github("walkerke/tigris")
library(tidycensus)
library(tidyverse)
library(tigris)

vars_2020 <- load_variables(2020,"pl",cache=TRUE)
vars_2010 <- load_variables(2010,"sf1", cache=TRUE)
vars_2019 <- load_variables(2019,"acs5", cache=TRUE)



##Hispanic = P004003 in 2010; P2_002N in 2020; B03001_003 in 2019 ACS

## Black (black alone) 	P003003 in 2010 P1_004N in 2020


```
 
Just how much has Durham changed demographically in the last ten years? 



```{r message=FALSE, warning=FALSE, include=FALSE}

durham_hispanic_2020 <- get_decennial(
  geography="block",
  variables="P2_002N",
  summary_var="P2_001N",
  state="NC",
  county="Durham",
  year=2020,
  geometry=TRUE
) %>% 
  mutate(pct_hispanic=100*(value/summary_value))

durham_hispanic_2010 <- get_decennial(
  geography="block",
  variables="P004003",
  summary_var="P004001",
  state="NC",
  county="Durham",
  year=2010,
  geometry=TRUE
) %>% 
  mutate(pct_hispanic=100*(value/summary_value))


 

```


```{r echo=FALSE, message=FALSE, warning=FALSE}
library(scales)
library(leaflet)

pal <- colorNumeric(
  palette = "YlOrRd", na.color = "#808080",
  domain = durham_hispanic_2010$pct_hispanic)


map <- leaflet() %>%
  addProviderTiles("CartoDB.Positron") %>%
  ##Hispanics
  addPolygons(data=durham_hispanic_2010,
              fillColor=~pal(pct_hispanic),
              stroke=FALSE, weight=2,fillOpacity = 0.7,
              popup = paste("GEOID: ", durham_hispanic_2010$GEOID , "<br>",
                            "Pct Hispanic: ", durham_hispanic_2010$pct_hispanic
                            ), 
              label="Hispanic 2010",
            group="Hispanic 2010") %>%

  
    addPolygons(data=durham_hispanic_2020,
              fillColor=~pal(pct_hispanic),
              stroke=FALSE, weight=2,fillOpacity = 0.7,
              popup = paste("GEOID: ", durham_hispanic_2020$GEOID , "<br>",
                            "Pct Hispanic: ", durham_hispanic_2020$pct_hispanic
                            ), 
              label="Hispanic 2020",
            group="Hispanic 2020") %>%
  addLegend("bottomright",
            pal=pal,
            value=durham_hispanic_2020$pct_hispanic,
            title="Percent Hispanic") %>%
  
  
    addLayersControl(baseGroups = c("Hispanic 2020", "Hispanic 2010"))

map

```






```{r message=FALSE, warning=FALSE, include=FALSE}
counties <- c("Durham", "Orange", "Wake")

three_2020 <- get_decennial(
  geography="tract",
  variables="P2_002N",
  summary_var="P2_001N",
  state="NC",
  county=counties,
  year=2020,
  geometry=TRUE
) %>% 
  mutate(pct_hispanic=100*(value/summary_value))

three_2010 <- get_decennial(
  geography="tract",
  variables="P004003",
  summary_var="P004001",
  state="NC",
  county=counties,
  year=2010,
  geometry=TRUE
) %>% 
  mutate(pct_hispanic=100*(value/summary_value))
# 
# three_2019 <- get_acs(
#   geography="block group",
#   variables="B03001_003",
#   summary_var="B03001_001",
#   state="NC",
#   county=counties,
#   year=2019,
#   geometry=TRUE
# ) %>% 
#   mutate(pct_hispanic=100*(value/summary_value))




```


```{r echo=FALSE, message=FALSE, warning=FALSE}


pal <- colorNumeric(
  palette = "YlOrRd", na.color = "#808080",
  domain = three_2010$pct_hispanic)


map <- leaflet() %>%
  addProviderTiles("CartoDB.Positron") %>%
  ##Hispanics
  addPolygons(data=three_2010,
              fillColor=~pal(pct_hispanic),
              stroke=FALSE, weight=2,fillOpacity = 0.7,
              popup = paste("GEOID: ", three_2010$GEOID , "<br>",
                            "Pct Hispanic: ", three_2010$pct_hispanic
                            ), 
              label="Hispanic 2010",
            group="Hispanic 2010") %>%

    addPolygons(data=three_2020,
              fillColor=~pal(pct_hispanic),
              stroke=FALSE, weight=2,fillOpacity = 0.7,
              popup = paste("GEOID: ", three_2020$GEOID , "<br>",
                            "Pct Hispanic: ", three_2020$pct_hispanic
                            ), 
              label="Hispanic 2020",
            group="Hispanic 2020") %>%
  addLegend("bottomright",
            pal=pal,
            value=three_2020$pct_hispanic,
            title="Percent Hispanic 2020") %>%
  
  
    addLayersControl(baseGroups = c("Hispanic 2020", "Hispanic 2010"))

map

```




















2020 census data is available at the block level, allowing us to see the concentration of population by race and age - and how those have changed since 2010. 

The goal of this blog will be to analyze how each congresssional district measures up to each other in demographic representation. Has Asheville's 11th become more or less white since 2010? Where are Hispanics, a growing percentage of 

Steps:

1. Overall compare 2010 to 2020 - how many more people, HH's, white-only, black and hispanics since 2010? 
2. Compare each congressional district's demographic data to each other - not so much diving into packing vs cracking, but just higher level comparison's. 

Let's load the 2019 Congressional District and take a look - what

```{r echo=FALSE, message=FALSE, warning=FALSE}
nc_congressional_2019 <- st_read("C:/Users/JacobFo/OneDrive - City of Durham/GitHub/Personal Blog/Personal Blog/Voting Districts/2019 NC Congressional/NC_Congress_2019.shp")
nc_congressional_2021 <- st_read("C:/Users/JacobFo/OneDrive - City of Durham/GitHub/Personal Blog/Personal Blog/Voting Districts/2021 NC Congressional/SL 2021-174 Congress.shp")

nc_congressional_2021$DISTRICT <- as.integer(nc_congressional_2021$DISTRICT)




nc_congressional_2021 <- nc_congressional_2021[order(nc_congressional_2021$DISTRICT),]

nc_congressional_2021$Partisan_Lean <- c(-18,1,-20,-10,25,42,-20,-20,45,-26,-16,-16,-25,-12)

##source for paritisan lean: https://projects.fivethirtyeight.com/redistricting-2022-maps/north-carolina/
nc_congressional_2021$color <- case_when(
       nc_congressional_2021$Partisan_Lean  < -19 ~ -3,
        nc_congressional_2021$Partisan_Lean < -10 ~ -2,
        nc_congressional_2021$Partisan_Lean < -5 ~ -1,
        nc_congressional_2021$Partisan_Lean < 5 ~ 0, 
        nc_congressional_2021$Partisan_Lean  < 10 ~ 1,
        nc_congressional_2021$Partisan_Lean > 10 ~ 2 
         
)

nc_congressional_2021$Pred_Party <- case_when(
       nc_congressional_2021$Partisan_Lean  < 0 ~ 0,
        nc_congressional_2021$Partisan_Lean > 0 ~ 1
         
)

trm_taz_g2 <- st_read("C:/Users/JacobFo/OneDrive - City of Durham/Archive/TRM_G2_TAZ_CaliperUpdated.shp")


temp <- st_transform(nc_congressional_2019, st_crs(trm_taz_g2)) %>% st_make_valid()

pal <- colorFactor(
  palette=c('blue','red'),
  domain=temp$sParty
)



temp_2021 <- st_transform(nc_congressional_2021, st_crs(trm_taz_g2)) %>% st_make_valid()

library(RColorBrewer)

colfunc <- colorRampPalette(c("#2C77BF", "red"))




pal_2021 <- colorFactor(
  palette=c('darkred','red', 'pink', 'grey', 'blue', 'darkblue'),
  domain=c(-3,-2,-1,0,1,2)
)



map <- leaflet(temp) %>%
  addProviderTiles("CartoDB.Positron") %>%
  addPolygons(data=temp, group="2019",
              popup=paste("Congressional District: ", temp$District, "<br>",
                          "Party: ", temp$sParty, "<br>",
                          "Representative 2019: ", temp$sName),
              weight=1,
              color =~pal(temp$sParty)) %>%
  addPolygons(data=temp_2021, group="2021",
              popup=paste("Congressional District: ", temp_2021$DISTRICT, "<br>", "Partisan Lean: ", temp_2021$Partisan_Lean ),dashArray="3", color =~pal_2021(temp_2021$color),
              weight=1, fillOpacity =0.5) %>%
  
  addLayersControl(baseGroups = c("2019", "2021"))


map
  
 


```






# EDA

Summarize black and hispanic representation

```{r echo=FALSE, message=FALSE, warning=FALSE}

hispanic_2020 <- get_decennial(
  geography="tract",
  variables="P2_002N",
  summary_var="P2_001N",
  state="NC",
  year=2020,
  geometry=TRUE
) %>% 
  mutate(pct_hispanic=100*(value/summary_value))



hispanic_2010 <- get_decennial(
  geography="tract",
  variables="P004003",
  summary_var="P004001",
  state="NC",
  year=2010,
  geometry=TRUE
) %>% 
  mutate(pct_hispanic=100*(value/summary_value))


hisp_pal <- colorNumeric(
  palette = "YlOrRd", na.color = "#808080",
  domain = hispanic_2020$pct_hispanic)


map <- leaflet(temp) %>%
  addProviderTiles("CartoDB.Positron") %>%
  addPolygons(data=temp, group="2019",
              popup=paste("Congressional District: ", temp$District, "<br>",
                          "Party: ", temp$sParty, "<br>",
                          "Representative 2019: ", temp$sName),
              weight=1,
              color =~pal(temp$sParty)) %>%
  addPolygons(data=temp_2021, group="2021",
              popup=paste("Congressional District: ", temp_2021$DISTRICT, "<br>", "Partisan Lean: ", temp_2021$Partisan_Lean ),dashArray="3", color =~pal_2021(temp_2021$color),
              weight=1, fillOpacity =0.5) %>%
  addPolygons(data=hispanic_2020, 
              popup=paste("Census Tract: ", hispanic_2020$GEOID, "<br>", "Percent Hispanic: ", hispanic_2020$pct_hispanic ),
              color =~hisp_pal(hispanic_2020$pct_hispanic),
              weight=1, fillOpacity =0.5,group="2020 Hispanic") %>%
  addPolygons(data=hispanic_2010, 
              popup=paste("Census Tract: ", hispanic_2010$GEOID, "<br>", "Percent Hispanic: ", hispanic_2010$pct_hispanic ),
              color =~hisp_pal(hispanic_2010$pct_hispanic),
              weight=1, fillOpacity =0.5,group="2010 Hispanic") %>%
      addLayersControl(baseGroups = c("2019", "2021", "2020 Hispanic", "2010 Hispanic"))
                       
map


```





## Model Discussion

What is the probability of a hispanic in North Carolina being represented by a Democrat in the US House of Representatives? What about a Republican? Newly released congressional redistricting, likely to be challenged in court, along with recently available 2020 demographic data provides an opportunity to delve deeper. 

First, we need to get the data. We're talking about the entire state, so the data is going to be large if we do anything more granular than census block group. Maybe even the tract will be good enough for now.


We need to start with getting the 2020 hispanic data for the entire state, what are the totals for each county, how has that changed from 2010.



```{r echo=FALSE, message=FALSE, warning=FALSE}
NC_Hisp_2020 <- get_decennial(
  geography="county",
  variables="P2_002N",
  summary_var="P2_001N",
  state="NC",
   year=2020,
  geometry=TRUE
) %>% 
  mutate(pct_hispanic=100*(value/summary_value),
         new_Name = sub(" County, North Carolina", "", NAME),
         Year=2020)

top_ten_2020 <- NC_Hisp_2020 %>%
  group_by(new_Name) %>%
  st_drop_geometry %>%
  summarize(Tot_Hisp = value,
            Hisp_Share = pct_hispanic) %>%
  arrange(desc(Tot_Hisp)) %>%
  mutate(Year='2020')





NC_Hisp_2010 <- get_decennial(
  geography="county",
  variables="P004003",
  summary_var="P004001",
  state="NC",
  year=2010,
  geometry=TRUE
) %>% 
   mutate(pct_hispanic=100*(value/summary_value),
         new_Name = sub(" County, North Carolina", "", NAME),
         Year=2010)


top_ten_2010 <- NC_Hisp_2010 %>%
  group_by(new_Name) %>%
  st_drop_geometry %>%
  summarize(Tot_Hisp = value,
            Hisp_Share = pct_hispanic) %>%
  arrange(desc(Tot_Hisp)) %>%
  mutate(Year='2010')



sample_counties <- top_ten_2020$new_Name[1:15]


combined <- rbind(top_ten_2020, top_ten_2010) 


temp<- combined %>%
  filter(new_Name %in% sample_counties)

arrange(temp, -Tot_Hisp)

#temp <- temp[1:30,]


p<-ggplot(data=temp, aes(x=(reorder(new_Name, Tot_Hisp)), y=Tot_Hisp, fill=Year)) +
  geom_bar(stat="identity", position='dodge') 

   
# Horizontal bar plot
p + coord_flip() +ylab("Total Hispanic Population") +xlab("County")



```


Take 2020 North Carolina Map by Census Tract, need to tag it to 2019 Congressional representation by party. 

## 2019 Model


```{r message=FALSE, warning=FALSE}


NC_Hisp_2020_bg <- get_decennial(
  geography="block group",
  variables= "P2_002N",
  summary_var="P2_001N",
  state="NC",
  year=2020,
  geometry=TRUE,
  #county="Durham"
)  %>%
   mutate(pct_hispanic=100*(value/summary_value),
         new_Name = sub(" County, Nsorth Carolina", "", NAME),
         Year=2020,
         GeoID = GEOID,
         Name = NAME)


NC_HH_2020_bg <- get_decennial(
  geography="block group",
  variables= "H1_003N",
  state="NC",
  year=2020,
  geometry=TRUE,
  #county="Durham"
)  %>%
   mutate(new_Name = sub(" County, Nsorth Carolina", "", NAME),
         Year=2020, HH_Vacant = value) 


NC_white_2020_bg <- get_decennial(
  geography="block group",
  variables= "P1_003N",
  summary_var="P2_001N",
  state="NC",
  year=2020,
  geometry=TRUE,
  #county="Durham"
)  %>%
   mutate(pct_white=100*(value/summary_value),
         new_Name = sub(" County, Nsorth Carolina", "", NAME),
         Year=2020) 


NC_black_2020_bg <- get_decennial(
  geography="block group",
  variables= "P1_004N",
  summary_var="P2_001N",
  state="NC",
  year=2020,
  geometry=TRUE,
  #county="Durham"
)  %>%
   mutate(pct_black=100*(value/summary_value),
         new_Name = sub(" County, Nsorth Carolina", "", NAME),
         Year=2020) 


final_bgs <- cbind(NC_Hisp_2020_bg, NC_black_2020_bg, NC_white_2020_bg, NC_HH_2020_bg ) %>%
  select(GeoID, Name, pct_black, pct_hispanic, pct_white, HH_Vacant, geometry)



temp <- st_transform(final_bgs, st_crs(nc_congressional_2019)) %>% st_make_valid()

## Tag the block groups, exported as centroids, to the congressional district

centroids <- temp %>%
 st_point_on_surface() %>%
  st_join(nc_congressional_2019 %>% select(sParty)) %>%
  mutate(Party = case_when(
    sParty == "Democrat" ~ 1,
    sParty=="Republican" ~ -0
  ))

## Build Logit model based off of centroids database, with sParty as the dummy variable, pctHispanic as the IV

model <- glm(Party ~pct_hispanic + pct_white + pct_black + HH_Vacant,family=binomial(link='logit'),data=centroids)

summary(model)


```


```{r}
train <- centroids[1:5333,]
test <- centroids[5334:7111,]


model <- glm(Party ~pct_hispanic + pct_white + pct_black + HH_Vacant,family=binomial(link='logit'),data=centroids)

summary(model)


pred <- predict(model, newdata = test, type = "response")

y_pred_num <- ifelse(pred > 0.5, 1, 0)
y_pred <- factor(y_pred_num, levels=c(0, 1))
y_act <- test$Party

mean(y_pred == y_act, na.rm=T) 



```



## 2021 Model

```{r message=FALSE, warning=FALSE}




final_bgs <- st_transform(final_bgs, st_crs(nc_congressional_2021)) %>% st_make_valid()

## Tag the block groups, exported as centroids, to the congressional district

centroids <- final_bgs %>%
 st_point_on_surface() %>%
  st_join(nc_congressional_2021 %>% select(Pred_Party)) 

## Build Logit model based off of centroids database, with sParty as the dummy variable, pctHispanic as the IV

model <- glm(Pred_Party ~pct_hispanic + pct_white + pct_black + HH_Vacant,family=binomial(link='logit'),data=centroids)

summary(model)


```


```{r}
train <- centroids[1:5333,]
test <- centroids[5334:7111,]


model <- glm(Pred_Party ~pct_hispanic + pct_white + pct_black + HH_Vacant,family=binomial(link='logit'),data=centroids)

summary(model)


pred <- predict(model, newdata = test, type = "response")

y_pred_num <- ifelse(pred > 0.5, 1, 0)
y_pred <- factor(y_pred_num, levels=c(0, 1))
y_act <- test$Pred_Party

mean(y_pred == y_act, na.rm=T) 



```










