---
title: "North Carolina Redistricting and Demographic Changes"
author:
  - name: Jacob Ford
    url: https://jford-dchcmpo.github.io/Blog/posts/2021-12-30-Redistricting-and-Racial-Targetting/
date: 12-30-2021
output:
  distill::distill_article:
    self_contained: false
---








```{r setup, include=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
library(caliperR)
library(nngeo)
library(tcadr)
library(sf)
library(leaflet)
library(PL94171)
library(janitor)
library(dplyr)
library(tidycensus)
library(tidyverse)
options(tigris_use_cache = TRUE)
library(sf)
library(data.table)
library(dplyr)
library(plotly)

# remotes::install_github("walkerke/tidycensus")
# remotes::install_github("walkerke/tigris")
library(tidycensus)
library(tidyverse)
library(tigris)

vars_2020 <- load_variables(2020,"pl",cache=TRUE)
vars_2010 <- load_variables(2010,"sf1", cache=TRUE)
vars_2019 <- load_variables(2019,"acs5", cache=TRUE)

trm_taz_g2 <- st_read("C:/Users/JacobFo/OneDrive - City of Durham/Archive/TRM_G2_TAZ_CaliperUpdated.shp")



nc_congressional_2019 <- st_read("C:/Users/JacobFo/OneDrive - City of Durham/GitHub/Personal Blog/Personal Blog/Voting Districts/2019 NC Congressional/NC_Congress_2019.shp") 

nc_congressional_2021 <- st_read("C:/Users/JacobFo/OneDrive - City of Durham/GitHub/Personal Blog/Personal Blog/Voting Districts/2021 NC Congressional/SL 2021-174 Congress.shp")

house_old<- st_read("C:/Users/JacobFo/OneDrive - City of Durham/GitHub/Personal Blog/Personal Blog/Voting Districts/NC_House_2019.shp")
house_new<- st_read("C:/Users/JacobFo/OneDrive - City of Durham/GitHub/Personal Blog/Personal Blog/Voting Districts/NC_House_2021.shp")

senate_old<- st_read("C:/Users/JacobFo/OneDrive - City of Durham/GitHub/Personal Blog/Personal Blog/Voting Districts/NC_Senate_2019.shp")
senate_new<- st_read("C:/Users/JacobFo/OneDrive - City of Durham/GitHub/Personal Blog/Personal Blog/Voting Districts/NC_Senate_2021.shp")

nc_congressional_2021$DISTRICT <- as.integer(nc_congressional_2021$DISTRICT)


##Change CRS


nc_congressional_2019 <- st_transform(nc_congressional_2019, st_crs(trm_taz_g2)) %>% st_make_valid()
nc_congressional_2021 <- st_transform(nc_congressional_2021, st_crs(trm_taz_g2)) %>% st_make_valid()
house_old <- st_transform(house_old, st_crs(trm_taz_g2)) %>% st_make_valid()
house_new <- st_transform(house_new, st_crs(trm_taz_g2)) %>% st_make_valid()
senate_old <- st_transform(senate_old, st_crs(trm_taz_g2)) %>% st_make_valid()
senate_new <- st_transform(senate_new, st_crs(trm_taz_g2)) %>% st_make_valid()




nc_congressional_2021 <- nc_congressional_2021[order(nc_congressional_2021$DISTRICT),]

nc_congressional_2021$Partisan_Lean <- c(-18,1,-20,-10,25,42,-20,-20,45,-26,-16,-16,-25,-12)

##source for paritisan lean: https://projects.fivethirtyeight.com/redistricting-2022-maps/north-carolina/
nc_congressional_2021$color <- case_when(
       nc_congressional_2021$Partisan_Lean  < -19 ~ -3,
        nc_congressional_2021$Partisan_Lean < -10 ~ -2,
        nc_congressional_2021$Partisan_Lean < -5 ~ -1,
        nc_congressional_2021$Partisan_Lean < 5 ~ 0, 
        nc_congressional_2021$Partisan_Lean  < 10 ~ 1,
        nc_congressional_2021$Partisan_Lean > 10 ~ 2 
         
)

nc_congressional_2021$Pred_Party <- case_when(
       nc_congressional_2021$Partisan_Lean  < 2 ~ 0,
        nc_congressional_2021$Partisan_Lean > 2 ~ 1
         
)




centroids <- st_read("C:/Users/JacobFo/OneDrive - City of Durham/GitHub/Personal Blog/Personal Blog/centroids.shp") %>%
  mutate(PARTY_2019 = P_2019) %>%
  filter(!(is.na(PARTY_2019)))




```
 




The long awaited 2020 Census data provides the best estimate of the distribution of population changes by racial composition, available from state to census block geographies. Coinciding with the constitutionally required release is the redistricting process for state legislatures and congressional districts. I live in Durham (called the Mecca of the South to many/most) in a state where unfettered partisan gerrymandering brazenly strikes advantages for the party in power, right now Republicans in the General Assembly. Plenty of astounding work by mathematicians like Dr Moon Duchin at Tufts and Dr Jonathan Mattingly at Duke are providing policymakers and engaged citizens with quantifiable tools to measure the consequences of the players making up their own rules, of the politicians drawing their own lines. This ain't that. 

In this, I use geospatial analyses of the newly released census data, using the smallest level geographic unit (census block y'all), to determine how the newly proposed 2021-2030 lines in the Tar Heel State interact with demographic shifts. Mainly, we'll be looking at racial composition and the party each block is represented by in US House of Representatives, and if I remember, the NC General Assembly. Given the large number of blocks in NC (236,638), a simplified ML logit model is deployed and given ample training data for boosting. The question(s) I'm looking to answer:

1. How has NC demographically over last ten years? (hint: a lot)
2. What demographics are most represented by either major political party? 
3. Did redistricting cause any particular racial group to increase likelihood of being represented by a particular party?
4. Why hasn't Mayor Elaine O'Neil formally changed the name to 'Mecca of the South' yet?  

Disclaimer: This is just an exploratory analysis and model, no where near the caliber of aforementioned actual scholars in the game. The model will be described in the below section, which I'm sure could be improved upon or entirely redesigned. But the richness of the data and the shift in representative districts is the important piece to focus on. 



## Redistricting


In the below map, you'll find both sets of US House district lines, what I'll call the 2019 (old) and the 2021(new). The 2019 districts are shaded by party. The 2021 are shaded by FiveThirtyEight's [Partisan Lean](https://projects.fivethirtyeight.com/redistricting-2022-maps/north-carolina/) for North Carolina's new districts. Note: these lines are facing legal challenges, but so far have survived the gauntlet. State senate and house districts are likewise provided, however I did not go ahead and predict the outcomes. Shapefiles are available on [NC OneMap](https://www.nconemap.gov/)

For the model preparation, I assume the predictions by *heads bow* Nate Silver and his team of god-fearing data wonks hold true, meaning the 2022 midterm elections follow the partisan lean exactly. This may likely be generous for Democrats, as the newly drawn 2nd District, where my own represenative in Congress GK Butterfield leaves a vacant seat, is just slightly in their favor at +1 D's. In this case, the North Carolina 2nd goes to the Republicans despite the +1 D advantage, deal with it. 



```{r echo=FALSE, message=FALSE, warning=FALSE}




congress_2019 <- st_transform(nc_congressional_2019, st_crs(trm_taz_g2)) %>% st_make_valid()

pal <- colorFactor(
  palette=c('blue','red'),
  domain=congress_2019$sParty
)



congress_2021 <- st_transform(nc_congressional_2021, st_crs(trm_taz_g2)) %>% st_make_valid()

library(RColorBrewer)

colfunc <- colorRampPalette(c("#2C77BF", "red"))




pal_2021 <- colorFactor(
  palette=c('darkred','red', 'pink', 'grey', 'blue', 'darkblue'),
  domain=c(-3,-2,-1,0,1,2)
)



map <- leaflet(congress_2019) %>%
  addProviderTiles("CartoDB.Positron") %>%
  ##Congress
  addPolygons(data=congress_2019, group="Congress Old",
              popup=paste("Congressional District: ", congress_2019$District, "<br>",
                          "Party: ", congress_2019$sParty, "<br>",
                          "Representative 2019: ", congress_2019$sName),
              weight=1,
              color =~pal(congress_2019$sParty)) %>%
  addPolygons(data=congress_2021, group="Congress New",
              popup=paste("Congressional District: ", congress_2021$DISTRICT, "<br>", "Partisan Lean: ", congress_2021$Partisan_Lean ),dashArray="3", color =~pal_2021(congress_2021$color),
              weight=1, fillOpacity =0.5) %>%
  
  ##Senate
  addPolygons(data=senate_old, group="Senate Old",
              popup=paste("Senate District: ", senate_old$District, "<br>",
                          "Party: ", senate_old$sParty, "<br>",
                          "Senator 2019: ", senate_old$sFirstName, " ", senate_old$sLastName),
              weight=1,
              color =~pal(senate_old$sParty)) %>%
  addPolygons(data=senate_new, group="Senate New",
              popup=paste("Congressional District: ", senate_new$District, "<br>" ),dashArray="3", color ='black',
              weight=2, fillOpacity =0) %>%
  ##House
  addPolygons(data=house_old, group="House Old",
              popup=paste("House District: ", house_old$District, "<br>",
                          "Party: ", house_old$sParty, "<br>",
                          "Representative 2019: ",  house_old$sFirstName, " ", house_old$sLastName),
              weight=1,
              color =~pal(house_old$sParty)) %>%
  addPolygons(data=house_new, group="House New",
              popup=paste("Congressional District: ", house_new$District, "<br>" ),dashArray="3", color ='black',
              weight=2, fillOpacity =0) %>%
  
  addLayersControl(overlayGroups = c("Congress Old", "Congress New", "Senate Old", "Senate New", "House Old", "House New"))

map %>% hideGroup("Congress New")%>% hideGroup("Senate New")%>% hideGroup("House New")%>% hideGroup("Senate Old") %>% hideGroup("House Old")



  
 


```



## Census & Demographic Changes





```{r eval=FALSE, message=FALSE, warning=FALSE, include=FALSE}

# NC_Hisp_2020_bg <- get_decennial(
#  geography="block",
#  variables= "P2_002N",
#  summary_var="P2_001N",
#  state="NC",
#  year=2020,
#  geometry=TRUE,
#  #county="Durham"
# )  %>%
#   mutate(pct_hispanic=100*(value/summary_value),
#         new_Name = sub(" County, Nsorth Carolina", "", NAME),
#         Year=2020,
#         GeoID = GEOID,
#         Name = NAME)
# 
# 
# NC_Asian_2020_bg <- get_decennial(
#  geography="block",
#  variables= "P1_006N",
#  summary_var="P1_001N",
#  state="NC",
#  year=2020,
#  geometry=TRUE,
#  #county="Durham"
# )  %>%
#   mutate(pct_asian=100*(value/summary_value),
#         new_Name = sub(" County, Nsorth Carolina", "", NAME),
#         Year=2020,
#         GeoID = GEOID,
#         Name = NAME)
# 
# 
# NC_HH_2020_bg <- get_decennial(
#  geography="block",
#  variables= "H1_003N",
#  state="NC",
#  year=2020,
#  geometry=TRUE,
#  #county="Durham"
# )  %>%
#   mutate(new_Name = sub(" County, Nsorth Carolina", "", NAME),
#         Year=2020, HH_Vacant = value)


# NC_white_2020_bg <- get_decennial(
#  geography="block",
#  variables= "P1_003N",
#  summary_var="P2_001N",
#  state="NC",
#  year=2020,
#  geometry=TRUE,
#  #county="Durham"
# )  %>%
#   mutate(pct_white=100*(value/summary_value),
#         new_Name = sub(" County, Nsorth Carolina", "", NAME),
#         Year=2020)
# 
# 
# NC_black_2020_bg <- get_decennial(
#  geography="block",
#  variables= "P1_004N",
#  summary_var="P2_001N",
#  state="NC",
#  year=2020,
#  geometry=TRUE,
#  #county="Durham"
# )  %>%
#   mutate(pct_black=100*(value/summary_value),
#         new_Name = sub(" County, Nsorth Carolina", "", NAME),
#         Year=2020)
# 
# NC_Income <- get_acs(
#  geography="block group",
#  variables= "B19301_001", #Median Income per Capita in 2019 Inflation Adjusted Dollars
#  state="NC",
#  year=2019,
#  geometry=TRUE,
# )  %>%
#   mutate(
#         new_Name = sub(" County, Nsorth Carolina", "", NAME),
#         Year=2020)
# 
# 
# 
# final_bgs <- cbind(NC_Hisp_2020_bg, NC_black_2020_bg, NC_white_2020_bg, NC_HH_2020_bg,NC_Asian_2020_bg ) %>%
#  select(GeoID, Name, pct_black, pct_hispanic, pct_white, pct_asian, HH_Vacant, geometry) %>%
#  mutate(pct_other = 100 - (pct_black + pct_white + pct_asian))
# 
# 
# 
# temp <- st_transform(final_bgs, st_crs(congress_2019)) %>% st_make_valid()
# 
# 
# centroids <- final_bgs %>%
#   st_point_on_surface() %>%
#   st_join(NC_Income %>%select(estimate)) %>%
#   mutate(Med_Income = estimate)



## Tag the block level exported as centroids, to the congressional district; note this takes approximately 4-6 hours

# centroids <- temp %>%
#  st_point_on_surface() %>%
#   st_join(nc_congressional_2019 %>% select(sParty),st_nn, k = 1, maxdist=500) %>%
#   mutate(Party_2019 = case_when(
#     sParty == "Democrat" ~ 1,
#     sParty=="Republican" ~ -0
#   ))


# centroids <- centroids %>%
#   st_join(nc_congressional_2021 %>% select(Pred_Party) ,st_nn, k = 1, maxdist=500) %>%
#   mutate(Party_2021=Pred_Party)

## Tagged the centroids in TransCAD, import back in - work smarter, not harder 



# temp <- st_transform(centroids, st_crs(nc_congressional_2021)) %>% st_make_valid()




hispanic_2020 <- get_decennial(
  geography="tract",
  variables="P2_002N",
  summary_var="P2_001N",
  state="NC",
  year=2020,
  geometry=TRUE
) %>% 
  mutate(pct_hispanic=100*(value/summary_value))



hispanic_2010 <- get_decennial(
  geography="tract",
  variables="P004003",
  summary_var="P004001",
  state="NC",
  year=2010,
  geometry=TRUE
) %>% 
  mutate(pct_hispanic=100*(value/summary_value))


hisp_pal <- colorNumeric(
  palette = "YlOrRd", na.color = "#808080",
  domain = hispanic_2020$pct_hispanic)


map <- leaflet(congress_2019) %>%
  addProviderTiles("CartoDB.Positron") %>%
   addPolygons(data=hispanic_2020, 
              popup=paste("Census Tract: ", hispanic_2020$GEOID, "<br>", "Percent Hispanic: ", hispanic_2020$pct_hispanic ),
              color =~hisp_pal(hispanic_2020$pct_hispanic),
              weight=1, fillOpacity =0.5,group="2020 Hispanic") %>%
  addPolygons(data=hispanic_2010, 
              popup=paste("Census Tract: ", hispanic_2010$GEOID, "<br>", "Percent Hispanic: ", hispanic_2010$pct_hispanic ),
              color =~hisp_pal(hispanic_2010$pct_hispanic),
              weight=1, fillOpacity =0.5,group="2010 Hispanic") %>%
      addLayersControl(baseGroups = c("2020 Hispanic", "2010 Hispanic"))
                       
map


```

Let's zoom out. From 2010 to 2020, North Carolina gained just over 900,000, making it one of six states to gain an additional seat (shout out Montana, Oregon, Colorado, Florida and Texas).

But the below graph shows a bit more to the story. The Black population stayed relatively constant, while Whites actually decreased. But more surprisingly, Hispanic and Asian populations dramatically increased relative to 2010 values. While only accounting for over 10% of total population, **Hispanic growth accounted for a third of the total state population growth that netted an additional seat in the US House**. 



### Total Growth by Race

```{r echo=FALSE, message=FALSE, warning=FALSE}

state_2010 <- get_decennial(
  geography="state",
  variables=c(Hispanic="P004003",
              White = "P003002",
              Black = "P003003",
              Asian= "P003005",
              Total = "P004001"),
  state="NC",
  year=2010,
  geometry=FALSE
) %>% 
  mutate(Year='2010')




state_2020 <- get_decennial(
  geography="state",
  variables=c(Hispanic="P2_002N",
              White = "P1_003N",
              Black = "P1_004N",
              Asian= "P1_006N",
              Total = "P2_001N"),
  state="NC",
  year=2020,
  geometry=FALSE
) %>% 
  mutate(Year = '2020')





compare <- rbind(state_2010, state_2020) 



library(plotly)
library(scales)

p<-ggplot(data=compare, aes(x=(reorder(variable, value)), y=value, fill=Year)) +
  geom_bar(stat="identity", position='dodge') +scale_y_continuous(label=comma)

options(scipen=5)
# Horizontal bar plot
p <- p + coord_flip() +ylab("Total Population") +xlab("Race") + ggtitle("Hispanic and Asian Population Booming, Whites Declining")
ggplotly(p) 


```








### Hispanic & Asian Growth Top Counties

The next graphs show which counties hold most of the Hispanic and Asian growth in North Carolina. Mecklenberg (Charlotte) and Wake (Raleigh and Cary) Counties are the heavy hitters. 

```{r echo=FALSE, message=FALSE, warning=FALSE}


##Hispanic##

NC_Hisp_2020 <- get_decennial(
  geography="county",
  variables="P2_002N",
  summary_var="P2_001N",
  state="NC",
   year=2020,
  geometry=FALSE
) %>% 
  mutate(pct_hispanic=100*(value/summary_value),
         new_Name = sub(" County, North Carolina", "", NAME),
         Year=2020)



top_ten_2020_hisp <- NC_Hisp_2020 %>%
  group_by(new_Name) %>%
 # st_drop_geometry %>%
  summarize(Tot_Hisp = value,
            Hisp_Share = pct_hispanic) %>%
  arrange(desc(Tot_Hisp)) %>%
  #adorn_totals('row') %>%
  mutate(Year='2020')




NC_Hisp_2010 <- get_decennial(
  geography="county",
  variables="P004003",
  summary_var="P004001",
  state="NC",
  year=2010,
  geometry=FALSE
) %>% 
   mutate(pct_hispanic=100*(value/summary_value),
         new_Name = sub(" County, North Carolina", "", NAME),
         Year=2010)
library(janitor)


top_ten_2010_hisp <- NC_Hisp_2010 %>%
  group_by(new_Name) %>%
 # st_drop_geometry %>%
  summarize(Tot_Hisp = value,
            Hisp_Share = pct_hispanic) %>%
  arrange(desc(Tot_Hisp)) %>%
 # adorn_totals('row')%>%
  mutate(Year='2010') 
  




sample_counties <- top_ten_2020_hisp$new_Name[1:15]

sample_counties <-append(sample_counties, "Total")


combined <- rbind(top_ten_2020_hisp, top_ten_2010_hisp) 


temp<- combined %>%
  filter(new_Name %in% sample_counties)

p<-ggplot(data=temp, aes(x=(reorder(new_Name, Tot_Hisp)), y=Tot_Hisp, fill=Year)) +
  geom_bar(stat="identity", position='dodge') 

options(scipen=5)
# Horizontal bar plot
p <- p + coord_flip() +ylab("Total Hispanic Population") +xlab("County") + ggtitle("Hispanic Population Growth in North Carolina, 2010-2020")

ggplotly(p) 






##Asian##

NC_Asian_2020 <- get_decennial(
  geography="county",
  variables="P1_006N",
  summary_var="P1_001N",
  state="NC",
   year=2020,
  geometry=FALSE
) %>% 
  mutate(pct_asian=100*(value/summary_value),
         new_Name = sub(" County, North Carolina", "", NAME),
         Year=2020)


NC_Asian_2010 <- get_decennial(
  geography="county",
  variables="P003005",
  summary_var="P003001",
  state="NC",
   year=2010,
  geometry=FALSE
) %>% 
  mutate(pct_asian=100*(value/summary_value),
         new_Name = sub(" County, North Carolina", "", NAME),
         Year=2010)


top_ten_2020_asian <- NC_Asian_2020 %>%
  group_by(new_Name) %>%
 # st_drop_geometry %>%
  summarize(Tot_Asian = value,
            Asian_Share = pct_asian) %>%
  arrange(desc(Tot_Asian)) %>%
 # adorn_totals('row') %>%
  mutate(Year='2020')


top_ten_2010_asian <- NC_Asian_2010 %>%
  group_by(new_Name) %>%
 # st_drop_geometry %>%
  summarize(Tot_Asian = value,
            Asian_Share = pct_asian) %>%
  arrange(desc(Tot_Asian)) %>%
 # adorn_totals('row')%>%
  mutate(Year='2010') 

combined <- rbind(top_ten_2020_asian, top_ten_2010_asian) 

  
temp<- combined %>%
  filter(new_Name %in% sample_counties)

p<-ggplot(data=temp, aes(x=(reorder(new_Name, Tot_Asian)), y=Tot_Asian, fill=Year)) +
  geom_bar(stat="identity", position='dodge') 

options(scipen=5)
# Horizontal bar plot
p <- p + coord_flip() +ylab("Total Asian Population") +xlab("County") + ggtitle("Asian Population Growth in North Carolina, 2010-2020")

ggplotly(p) 




```





### Hispanic & Asian Percentage Top Counties

From previous graphs, Asian and Hispanics combined make up approximately 15% of the entire state's population. Below are the top counties by proportion of Asian/Hispanic population: 

```{r echo=FALSE, message=FALSE, warning=FALSE}


##Hispanic##




top_ten_2020_hisp <- NC_Hisp_2020 %>%
  group_by(new_Name) %>%
 # st_drop_geometry %>%
  summarize(Tot_Hisp = value,
            Hisp_Share = pct_hispanic,
            Tot_Pop = summary_value) %>%
  arrange(desc(Hisp_Share)) %>%
  mutate(Year='2020')



top_ten_2010_hisp <- NC_Hisp_2010 %>%
  group_by(new_Name) %>%
 # st_drop_geometry %>%
  summarize(Tot_Hisp = value,
            Hisp_Share = pct_hispanic,
            Tot_Pop = summary_value) %>%
  arrange(desc(Hisp_Share)) %>%
  mutate(Year='2010') 
  


sample_counties <- top_ten_2020_hisp$new_Name[1:15]


combined <- rbind(top_ten_2020_hisp, top_ten_2010_hisp) 


temp<- combined %>%
  filter(new_Name %in% sample_counties)

p<-ggplot(data=temp, aes(x=(reorder(new_Name, Hisp_Share)), y=Hisp_Share, fill=Year)) +
  geom_bar(stat="identity", position='dodge') 

options(scipen=5)
# Horizontal bar plot
p <- p + coord_flip() +ylab("Hispanic % of Total Population") +xlab("County") + ggtitle("Hispanic Proportional Total, 2010-2020")

ggplotly(p) 






##Asian##



top_ten_2020_asian <- NC_Asian_2020 %>%
  group_by(new_Name) %>%
 # st_drop_geometry %>%
  summarize(Tot_Asian = value,
            Asian_Share = pct_asian) %>%
  arrange(desc(Asian_Share)) %>%
 # adorn_totals('row') %>%
  mutate(Year='2020')


top_ten_2010_asian <- NC_Asian_2010 %>% 
  group_by(new_Name) %>%
 # st_drop_geometry %>%
  summarize(Tot_Asian = value,
            Asian_Share = pct_asian) %>%
  arrange(desc(Asian_Share)) %>%
#  adorn_totals('row')%>%
  mutate(Year='2010') 

combined <- rbind(top_ten_2020_asian, top_ten_2010_asian) 

  
temp<- combined %>%
  filter(new_Name %in% sample_counties)

p<-ggplot(data=temp, aes(x=(reorder(new_Name, Asian_Share)), y=Asian_Share, fill=Year)) +
  geom_bar(stat="identity", position='dodge') 

options(scipen=5)
# Horizontal bar plot
p <- p + coord_flip() +ylab("Asian % of Total Population") +xlab("County") + ggtitle("Asian Proportional Total, 2010-2020")

ggplotly(p) 




```


### Putting it All Together: Difference in Population by Race in North Carolina, 2010-2020

Remember all that jazz about North Carolina gaining another seat in Congress? We've seen a disproportionate amount of growth has been caused by minorities, in particular Hispanic and Asians. Guildford County, where Greensboro and nearby Winston Salem reside, saw a net-negative of white population by 2020, but positive growth in each other observed race. In the northeastern part of the state, an economically distressed agricultural sector, negative population growth is observed, mainly contributed by black populace leaving. 


Click on the top right icon to switch between different races: 

```{r echo=FALSE, message=FALSE, warning=FALSE}
nc_2010 <- get_decennial(
  geography="county",
  variables=c(Hispanic="P004003",
              White = "P003002",
              Black = "P003003",
              Asian= "P003005",
              Total = "P004001"),
  state="NC",
  year=2010,
  geometry=TRUE
) %>% 
  mutate(Year='2010',
        County_Name = sub(" County, North Carolina", "", NAME)) %>%
  group_by(County_Name) %>%
  summarize(Hispanic_2010 = value[variable=="Hispanic"],
            White_2010 = value[variable=="White"],
            Black_2010 = value[variable=="Black"],
            Asian_2010 = value[variable=="Asian"],
            Total_2010 = value[variable=="Total"]) %>%
  st_drop_geometry()




nc_2020 <- get_decennial(
  geography="county",
  variables=c(Hispanic="P2_002N",
              White = "P1_003N",
              Black = "P1_004N",
              Asian= "P1_006N",
              Total = "P2_001N"),
  state="NC",
  year=2020,
  geometry=TRUE
) %>% 
  mutate(Year = '2020',
        County_Name = sub(" County, North Carolina", "", NAME)) %>%
  group_by(County_Name) %>%
  summarize(Hispanic_2020 = value[variable=="Hispanic"],
            White_2020 = value[variable=="White"],
            Black_2020 = value[variable=="Black"],
            Asian_2020 = value[variable=="Asian"],
            Total_2020 = value[variable=="Total"])%>%
  st_drop_geometry()


combined <- cbind(nc_2010, nc_2020)

combined$White_Diff <- combined$White_2020-combined$White_2010
combined$Hisp_Diff <- combined$Hispanic_2020-combined$Hispanic_2010
combined$Black_Diff <- combined$Black_2020-combined$Black_2010
combined$Asian_Diff <- combined$Asian_2020-combined$Asian_2010
combined$Total_Diff <- combined$Total_2020-combined$Total_2010

combined <- combined [-1]

combined <- combined %>%
  select(County_Name, White_Diff, Hisp_Diff, Black_Diff, Asian_Diff, Total_Diff)


## Grab blank Geo

empty_geo <- get_decennial(
  geography="county",
  variables=c(test="P2_002N"),
  state="NC",
  year=2020,
  geometry=TRUE
) %>%
  mutate(County_Name = sub(" County, North Carolina", "", NAME))

temp <- merge(empty_geo, combined)




rc1 <- colorRampPalette(colors = c("red", "white"), space = "Lab")(22152)
rc2 <- colorRampPalette(colors = c("white", "darkgreen"), space = "Lab")(66000)
rampcols <- c(rc1, rc2)

pal_white20 <- colorNumeric(palette = rampcols, domain = temp$White_Diff)

rc1 <- colorRampPalette(colors = c("red", "white"), space = "Lab")(6200)
rc2 <- colorRampPalette(colors = c("white", "darkgreen"), space = "Lab")(47000)
rampcols <- c(rc1, rc2)

pal_black20 <- colorNumeric(palette = rampcols, domain = temp$Black_Diff)

rc1 <- colorRampPalette(colors = c("red", "white"), space = "Lab")(1200)
rc2 <- colorRampPalette(colors = c("white", "darkgreen"), space = "Lab")(57000)
rampcols <- c(rc1, rc2)

pal_hisp20 <- colorNumeric(palette = rampcols, domain = temp$Hisp_Diff)

rc1 <- colorRampPalette(colors = c("red", "white"), space = "Lab")(85)
rc2 <- colorRampPalette(colors = c("white", "darkgreen"), space = "Lab")(48000)
rampcols <- c(rc1, rc2)

pal_asian20 <- colorNumeric(palette = rampcols, domain = temp$Asian_Diff)

rc1 <- colorRampPalette(colors = c("red", "white"), space = "Lab")(17000)
rc2 <- colorRampPalette(colors = c("white", "darkgreen"), space = "Lab")(228000)
rampcols <- c(rc1, rc2)

pal_total <- colorNumeric(palette = rampcols, domain = temp$Total_Diff)




county_map <- leaflet()  %>%
  addProviderTiles("CartoDB.Positron") %>%
  addPolygons(data=temp, group="White",
              popup=paste("County Name: ", temp$County_Name, "<br>",
                          "White Difference: ", temp$White_Diff, "<br>"),
              weight=2, fillOpacity=0.7, color=~pal_white20(White_Diff)) %>%
  
  addPolygons(data=temp, group="Black",
              popup=paste("County Name: ", temp$County_Name, "<br>",
                          "Black Difference: ", temp$Black_Diff, "<br>"),
              weight=2, fillOpacity=0.7, color=~pal_black20(Black_Diff)) %>%
  addPolygons(data=temp, group="Hispanic",
              popup=paste("County Name: ", temp$County_Name, "<br>",
                          "Hispanic Difference: ", temp$Hisp_Diff, "<br>"),
              weight=2, fillOpacity=0.7, color=~pal_hisp20(Hisp_Diff)) %>%
  
  addPolygons(data=temp, group="Asian",
              popup=paste("County Name: ", temp$County_Name, "<br>",
                          "Asian Difference: ", temp$Asian_Diff, "<br>"),
              weight=2, fillOpacity=0.7, color=~pal_asian20(Asian_Diff)) %>%
  addPolygons(data=temp, group="Total",
              popup=paste("County Name: ", temp$County_Name, "<br>",
                          "Total Difference: ", temp$Total_Diff, "<br>"),
              weight=2, fillOpacity=0.7, color=~pal_total(Total_Diff)) %>%
  
  
  
  addLayersControl(baseGroups = c("Black", "White","Asian", "Hispanic", "Total"))

  
county_map



```



### Race by Representative

The average republican congressional district in North Carolina with the old lines was actually less white compared to the new lines proposed. May be just a natural reflection of white population declining in certain areas (see above map). 

More interestingly, the average black population increased for democrats by 3 percentage points, while Asian and Hispanics in Republican districts remained relatively consistent the Democratic districts saw sharp rises in average representation. Could imply the demographic shifts and the drawing of new lines may result in higher likelihood for minority North Carolinians to be drawn into a democratic district? Not entirely sold yet. Also, the average income for Democratic districts in the new lines are starkly higher than previous. 

```{r echo=FALSE, message=FALSE, warning=FALSE}



centroids$Med_income_log <- case_when(
  centroids$MD_INCM == 0 ~ 0,
  centroids$MD_INCM > 0 ~ log(centroids$MD_INCM))

## 2019 
temp <- centroids %>%
  st_drop_geometry() %>%
  mutate(`PARTY 2019` = case_when(
    PARTY_2019 == 0 ~ "Republican",
    PARTY_2019 == 1 ~ "Democrat"
  )) %>%
  group_by(`PARTY 2019`) %>%
  summarize(Mean_white = mean(PCT_WHT, na.rm=T),
            Mean_black = mean(PCT_BLC, na.rm=T),
            Mean_hispanic = mean(PCT_HSP, na.rm=T),
            Mean_asian = mean(PCT_ASN, na.rm=T),
            Mean_inc = mean(MD_INCM, na.rm=T))

library(DT)

datatable(temp, caption = "Average Racial Breakdown by 2019 Congressional Representation") %>%
  formatRound('Mean_white', 3) %>%
  formatRound('Mean_black', 3) %>%
  formatRound('Mean_hispanic', 3) %>%
  formatRound('Mean_asian', 3) %>%
  formatRound('Mean_inc',2)

## 2020

temp <- centroids %>%
  st_drop_geometry() %>%
  mutate(`PARTY 2021` = case_when(
    PARTY_2021 == 0 ~ "Republican",
    PARTY_2021 == 1 ~ "Democrat"
  )) %>%
  group_by(`PARTY 2021`) %>%
  summarize(Mean_white = mean(PCT_WHT, na.rm=T),
            Mean_black = mean(PCT_BLC, na.rm=T),
            Mean_hispanic = mean(PCT_HSP, na.rm=T),
            Mean_asian = mean(PCT_ASN, na.rm=T),
            Mean_inc = mean(MD_INCM, na.rm=T))

library(DT)

datatable(temp, caption = "Average Racial Breakdown by 2021 Congressional Representation") %>%
  formatRound('Mean_white', 3) %>%
  formatRound('Mean_black', 3) %>%
  formatRound('Mean_hispanic', 3) %>%
  formatRound('Mean_asian', 3) %>%
  formatRound('Mean_inc',2)


```




## Model Discussion

To keep things simple yet spicey, let's use a bare bones logit model on likelihood of being represented by a Democrat relative to a Republican. We'll analyze both the old and the new congressional districts. You see now why it was important to roll with the FiveThirtyEight projections, we need definitive results for projected house membership in 2022 midterms. 

As mentioned previously there are nearly a quarter million census blocks in North Carolina. The centroid of each block, is tagged to each congressional district's representation (D or R). The main benefit of using blocks instead of much larger tracts or block groups, even counties, is two-fold. 

1. Larger - in fact massive -  n-size, hence larger train/test dataset for ML application
2. Avoid tagging errors, i.e. county/tract/block group lines that intersect with congressional district lines. This is a common geospatial principle, and avoiding overlaps is preferred.


```{r message=FALSE, warning=FALSE, include=FALSE}

##Train and Test Data Sets

centroids <- centroids %>% st_drop_geometry()
train <- centroids[1:177478,]
test <- centroids[177479:236638,]

```




```{r message=FALSE, warning=FALSE, include=FALSE}

### 2019 Model Outputs

model_2019_blocks <- glm(PARTY_2019 ~PCT_HSP + PCT_WHT + PCT_BLC + PCT_ASN + Med_income_log ,family=binomial(link='logit'),data=train)

summary(model_2019_blocks)





```


```{r message=FALSE, warning=FALSE, include=FALSE}
### 2021 Model Outputs


model_2021 <- glm(PARTY_2021 ~PCT_HSP + PCT_WHT + PCT_BLC + PCT_ASN + Med_income_log ,family=binomial(link='logit'),data=train)

summary(model_2021)



```



## Logistic Regression Curve

```{r echo=FALSE, message=FALSE, warning=FALSE}

ggplot(test, aes(x=PCT_ASN, y=PARTY_2019)) + geom_point(fill='red') + 
  stat_smooth(method="glm", method.args=list(family=binomial(link='logit')), se=FALSE)+theme_minimal()+ scale_x_continuous(name="Percent Asian") +
  scale_y_continuous(name="Percent Democrat 2019")+ggtitle("2019 Districts Asian")

ggplot(test, aes(x=PCT_ASN, y=PARTY_2019)) + geom_point() + 
  stat_smooth(method="glm", method.args=list(family=binomial(link='logit')), se=FALSE)+theme_minimal()+ scale_x_continuous(name="Percent Asian") +
  scale_y_continuous(name="Percent Democrat 2021")+ggtitle("2021 Districts Asian")



ggplot(test, aes(x=PCT_BLC, y=PARTY_2019)) + geom_point() + 
  stat_smooth(method="glm", method.args=list(family=binomial(link='logit')), se=FALSE)+theme_minimal()+ scale_x_continuous(name="Percent Black") +
  scale_y_continuous(name="Percent Democrat 2019")+ggtitle("2019 Districts Black")

ggplot(test, aes(x=PCT_BLC, y=PARTY_2021)) + geom_point() + 
  stat_smooth(method="glm", method.args=list(family=binomial(link='logit')), se=FALSE)+theme_minimal()+ scale_x_continuous(name="Percent Black") +
  scale_y_continuous(name="Percent Democrat 2021")+ggtitle("2021 Districts Black")


ggplot(test, aes(x=PCT_WHT, y=PARTY_2019)) + geom_point(fill='red') + 
  stat_smooth(method="glm", method.args=list(family=binomial(link='logit')), se=FALSE)+theme_minimal()+ scale_x_continuous(name="Percent White") +
  scale_y_continuous(name="Percent Democrat 2019")+ggtitle("2019 Districts White")

ggplot(test, aes(x=PCT_WHT, y=PARTY_2021)) + geom_point() + 
  stat_smooth(method="glm", method.args=list(family=binomial(link='logit')), se=FALSE)+theme_minimal()+ scale_x_continuous(name="Percent White") +
  scale_y_continuous(name="Percent Democrat 2021")+ggtitle("2021 Districts White")


ggplot(test, aes(x=PCT_HSP, y=PARTY_2019)) + geom_point(fill='red') + 
  stat_smooth(method="glm", method.args=list(family=binomial(link='logit')), se=FALSE)+theme_minimal()+ scale_x_continuous(name="Percent Hispanic") +
  scale_y_continuous(name="Percent Democrat 2019")+ggtitle("2019 Districts Hispanic")

ggplot(test, aes(x=PCT_HSP, y=PARTY_2019)) + geom_point() + 
  stat_smooth(method="glm", method.args=list(family=binomial(link='logit')), se=FALSE)+theme_minimal()+ scale_x_continuous(name="Percent Hispanic") +
  scale_y_continuous(name="Percent Democrat 2021")+ggtitle("2021 Districts Hispanic")





```

Ok what the hell is going on here. 

For blacks, the probability of residing in a democratic district (as one would expect) rises as percentage of black residents increase. However the peak is lower, suggesting that heavily populated black areas are possibly being newly represented by republicans in 2021 (thank you newly drawn NC #2 district). 

Whites see a nearly identical curve, just shifted downwards, implying that whites are being much more efficiently collected in republican districts.

Hispanics are being newly represented as well, as the likelihood across the distribution of percentage Hispanic remains nearly flat. 

And goodness, if you google logit curve you should immediatley get a picture of that final Asian Logit curve. What a beaut. The consistency between different years is likely the result of small represntation overall in the state, though clearly they are the most dependable democratic demographic as the data shows. 


## Model Fits


Predictive fit of model using 2019 congressional districts, this tells us how accurate the supervised regression model performs. For 2019, the machine learning model was able to accurate predict at 71.1%; but the 2021 saw a drastic increase to 88.3%. This suggests the 2021 districts, as the model is constructed, is sorting out it's voters more effectively. 

```{r echo=FALSE, message=FALSE, warning=FALSE}

## Predictive Fits

pred <- predict(model_2019_blocks, newdata = test, type = "response")



y_pred_num <- ifelse(pred > 0.5, 1, 0)
y_pred <- factor(y_pred_num, levels=c(0, 1))
y_act <- test$PARTY_2019

pred_2019 <- mean(y_pred == y_act, na.rm=T) 

pred <- predict(model_2021, newdata = test, type = "response")

y_pred_num <- ifelse(pred > 0.5, 1, 0)
y_pred <- factor(y_pred_num, levels=c(0, 1))
y_act <- test$PARTY_2021

pred_2021 <- mean(y_pred == y_act, na.rm=T) 

vals <- c(pred_2019, pred_2021)

df <- data.frame(Year = c('2019', '2021'),vals)

df$vals <- round(df$vals, 3)



ggplot(df, aes(x=Year, y=vals))+geom_bar(stat='identity', position='dodge') + geom_text(aes(label=vals), vjust=-0.25)+
  xlab("Year")+ylab("Predictive Strength")+theme_minimal()+ggtitle("Logit Model Accuracy")


```



This doesn't prove racial gerrymandering. It could reflect the 'Big Sort' occuring over ten years, or carpet-baggers like yours truly coming down South with our big liberal/socialist agenda, congregating in big cities which may intersect with growing political sorting happening more broadly. Nonetheless, the model results for the 2021 lines are encouraging, in a sense if we wanted to prove the newly designed lines better choose their voters for their politicans. 




```{r message=FALSE, warning=FALSE, include=FALSE}

## Odds Ratios
exp(coef(model_2019_blocks))
exp(coef(model_2021))

exp(cbind(OR = coef(model_2019_blocks), confint(model_2019_blocks)))
exp(cbind(OR = coef(model_2021), confint(model_2021)))



```




## Odds Ratio Box Plot

Finally, the odds ratios below show that 2021 lines are more fair to black North Carolinians, while Hispanics and Asians are being sorted into Democratic districts more in the newly drawn districts. We saw previously they were the fastest growing demographic in the State, and now we see how state lawmakers intend on responding to this trend for the next decade. 

Additionally, wealthier areas are staggeringly more likely to be sorted into democratic districts in the new lines. Booming cities like Raleigh, Greensboro, Cary and Mecca of the South are magnets for high paying jobs, for the mean time low costs of living, lower tax rates relative to the NE corridor and West Coast; all these likely contribute to this I'd venture. 

```{r echo=FALSE, message=FALSE, warning=FALSE}
boxLabels = c("Hispanic", "White", "Black", "Asian")

##2019


df <- data.frame(lables=boxLabels, 
                  boxOdds = c(1.0021304779, 0.9934778163  , 1.0200081806 ,1.0312674226    ), 
                        boxCILow = c(1.0014661525   , 0.9931773600   ,1.0195372923 ,1.0295998976     ), 
                        boxCIHigh = c(1.002793072, 0.993778233, 1.020480101,1.032950946))

p <- ggplot(df, aes(x = boxOdds, y = boxLabels)) 


ggplot(data = df,
       mapping = aes(y = forcats::fct_inorder(f = (x = boxLabels)))) +
  geom_vline(xintercept = 1) +
  geom_point(mapping = aes(x = boxOdds)) +
  geom_errorbarh(mapping = aes(xmin = boxCILow,
                               xmax = boxCIHigh)) +
  coord_trans(x = scales::exp_trans()) +
  # scale_x_continuous(breaks = log(x = 0.5 * (1:10)),
  #                    minor_breaks = NULL,
  #                    labels = (0.5 * (1:10))) +
  labs(x = "Odds Ratio",
       y = "") +theme_minimal() + ggtitle("2019 Model Odds Ratios, Race")


##2021


df <- data.frame(lables=boxLabels, boxOdds = c(1.012368848609690   , 
0.993498405513978   , 1.013385901077802,1.042262592003207    ), boxCILow = c(1.011481634734796   , 0.993044840129250   ,1.012728356907708,1.040464698203379   ), 
                        boxCIHigh = c(1.013251325461511, 0.993952139817316, 1.014042344750129,1.044072940422991))

p <- ggplot(df, aes(x = boxOdds, y = boxLabels)) 


ggplot(data = df,
       mapping = aes(y = forcats::fct_inorder(f = (x = boxLabels)))) +
  geom_vline(xintercept = 1) +
  geom_point(mapping = aes(x = boxOdds)) +
  geom_errorbarh(mapping = aes(xmin = boxCILow,
                               xmax = boxCIHigh)) +
  coord_trans(x = scales::exp_trans()) +
  # scale_x_continuous(breaks = log(x = 0.5 * (1:10)),
  #                    minor_breaks = NULL,
  #                    labels = (0.5 * (1:10))) +
  labs(x = "Odds Ratio",
       y = "") +theme_minimal() + ggtitle("2021 Model Odds Ratios, Race")




# Median Income


boxLabels = c("2019 District", "2021 Districts")

df <- data.frame(lables=boxLabels, boxOdds = c(2.0259539656   , 5.310856286752776    ), boxCILow = c(1.9723423285   , 5.108356308166039   ), 
                        boxCIHigh = c(2.081119204,5.521796860873518))

p <- ggplot(df, aes(x = boxOdds, y = boxLabels)) 


ggplot(data = df,
       mapping = aes(y = forcats::fct_inorder(f = (x = boxLabels)))) +
  geom_vline(xintercept = 1) +
  geom_point(mapping = aes(x = boxOdds)) +
  geom_errorbarh(mapping = aes(xmin = boxCILow,
                               xmax = boxCIHigh)) +
  coord_trans(x = scales::exp_trans()) +
  # scale_x_continuous(breaks = log(x = 0.5 * (1:10)),
  #                    minor_breaks = NULL,
  #                    labels = (0.5 * (1:10))) +
  labs(x = "Odds Ratio",
       y = "") +theme_minimal() + ggtitle("Median Income Logged")




```


## Random Forest 

Random Forests are possibly the most widely used ML model. Will the logit model results be supported, refuted, or a big collective shrug be the result?

The 2021 lines from the logit model showed a better predictive fit, suggesting the political lines are better desigend to predict political outcomes, or in other words, politicians picking voters instead of the reverse. 

In the blow importance plots, you see the variables ranked by predictive strength for the party represented being a Democrat. 

```{r echo=FALSE, message=FALSE, warning=FALSE}
library(randomForest)

model_data <- centroids %>% 
  select(PARTY_2019,PARTY_2021, PCT_BLC, PCT_HSP, PCT_WHT, PCT_ASN, Med_income_log)
model_data$PARTY_2021 <- as.factor(model_data$PARTY_2021)
model_data$PARTY_2019 <- as.factor(model_data$PARTY_2019)

samp <- sample(nrow(model_data), 0.8*nrow(model_data))

train <- model_data[samp,]
test <- model_data[-samp,]

RF_2019 <- randomForest(
  formula = PARTY_2019 ~ PCT_BLC + PCT_HSP+PCT_WHT+PCT_ASN + Med_income_log,
  data=train,
  importance=TRUE
)

# importance(RF_2019)
varImpPlot(RF_2019)


RF_2021<- randomForest(
  formula = PARTY_2021 ~ PCT_BLC + PCT_HSP+PCT_WHT+PCT_ASN + Med_income_log,
  data=train,
  importance=TRUE
)

# importance(RF_2021)
varImpPlot(RF_2021)

```


```{r echo=FALSE, message=FALSE, warning=FALSE}



p <- predict(RF_2019, newdata=test)
# table(p, test$PARTY_2019)

results <- cbind(p, test$PARTY_2019)

colnames(results) <- c('pred','real')
results <- as.data.frame(results)

pred_2019 <- sum(p==test$PARTY_2019) / nrow(test)





p <- predict(RF_2021, newdata=test)
# table(p, test$PARTY_2021)

results <- cbind(p, test$PARTY_2021)

colnames(results) <- c('pred','real')
results <- as.data.frame(results)

pred_2021 <- sum(p==test$PARTY_2021) / nrow(test)





vals <- c(pred_2019, pred_2021)

df <- data.frame(Year = c('2019', '2021'),vals)

df$vals <- round(df$vals, 3)



ggplot(df, aes(x=Year, y=vals))+geom_bar(stat='identity', position='dodge') + geom_text(aes(label=vals), vjust=-0.25)+
  xlab("Year")+ylab("Predictive Strength")+theme_minimal()+ggtitle("Random Forest Model Accuracy")

```


From the above, the results seen in the prior logit model are improved upon. 90.2% accuracy by 2021, just using income and demograhics. 

## Conclusion

Going into this post, getting a bit out of hand, I didn't exactly expect to see definitive evidence of black and brown citizens being walled into a different political district. However, after seeing the results from both models, I'm a bit surprised at the results. The 2021 lines are being challenged in court now, using much more sophisticated methods of analyzing gerrymandering as I mentioned. But these simplified results show that at the very least, demographic and income sorting into political parties is becoming more clear. The chicken or the egg question here is not to be ignored, but my personal opinion is we shouldn't leave the possibility of voters being selected by politicans up to chance. Politicians should always be chosen by voters. North Carolina should follow Michigan's example, establish a commission to fairly redistrict. 






## References

1. https://stats.idre.ucla.edu/r/dae/logit-regression/

2. http://r-statistics.co/Logistic-Regression-With-R.html 

3. https://github.com/alarm-redist/redist/

4. Michigan example in NYTimes: https://www.nytimes.com/2021/12/29/us/politics/michigan-congressional-maps.html





